<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call (PeerJS) - Đã sửa lỗi</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
        h1, h3 { color: #333; }
        .controls { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .videos { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        video { width: 100%; border-radius: 8px; background: #000; }
        #remoteVideo { cursor: pointer; } 
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        #myId { font-weight: bold; color: #d9534f; }
        .status { font-style: italic; color: #555; }
    </style>
</head>
<body>
    <h1>Video Call với PeerJS</h1>
    
    <div class="controls">
        <h3>1. Kết nối Server</h3>
        <p>ID của bạn: <strong id="myId">Đang kết nối...</strong></p>
        <p class="status" id="callStatus">Trạng thái: Sẵn sàng</p>
    </div>

    <div class="controls">
        <h3>2. Gọi</h3>
        <input type="text" id="callId" placeholder="Nhập ID của người kia">
        <button id="callBtn" onclick="makeCall()">Gọi</button>
        <button id="hangUpBtn" onclick="hangUp()" disabled>Kết thúc</button>
    </div>

    <div class="videos">
        <div>
            <h3>Bạn (Local)</h3>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <div>
            <h3>Bạn bè (Remote)</h3>
            <video id="remoteVideo" autoplay muted playsinline 
                   title="Click vào đây để BẬT VIDEO và ÂM THANH"></video>
        </div>
    </div>

    <script>
        // ================================================================
        // ***** URL CỦA BẠN ĐÃ ĐƯỢC CẬP NHẬT Ở ĐÂY *****
        // ================================================================
        const MY_RENDER_SERVER_URL = 'videocall-zlxx.onrender.com';
        // ================================================================


        let peer;
        let localStream;
        let currentCall;

        // Cấu hình ICE Servers (STUN và TURN)
        const iceConfig = {
            'iceServers': [
                // 1. Giữ máy chủ STUN của Google
                { urls: 'stun:stun.l.google.com:19302' }, 
                
                // 2. Thêm cấu hình TURN mới của bạn
                {
                    // Dùng External IP và Listening Port (21500)
                    urls: 'turn:51.255.83.152:21500?transport=udp',
                    username: 'nstd',    // Username bạn đã tạo ở Bước 3
                    credential: '2503' // Password bạn đã tạo ở Bước 3
                },
                {
                    urls: 'turn:51.255.83.152:21500?transport=tcp',
                    username: 'nstd',
                    credential: '2503'
                }
            ]
        };


        (async function() {
            // 1. Lấy video/âm thanh
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
            } catch (err) {
                console.error("Lỗi: Không thể truy cập camera/mic.", err);
                alert("Không thể truy cập camera/mic. Vui lòng cấp quyền và tải lại trang.");
                return;
            }

            // 2. Khởi tạo Peer
            peer = new Peer(undefined, {
                host: MY_RENDER_SERVER_URL,
                port: 443, 
                path: '/',
                secure: true,
                config: iceConfig
            });

            // 3. Hiển thị ID khi kết nối thành công
            peer.on('open', id => {
                console.log('Kết nối PeerJS thành công, ID của tôi là:', id);
                document.getElementById('myId').textContent = id;
            });

            // Xử lý lỗi kết nối
            peer.on('error', err => {
                console.error('Lỗi PeerJS:', err);
                alert(`Không thể kết nối đến Peer Server. Kiểm tra lại URL Render.\nLỗi: ${err.message}`);
                document.getElementById('myId').textContent = "Lỗi kết nối";
            });

            // 4. Lắng nghe cuộc gọi đến
            peer.on('call', call => {
                if (currentCall) {
                    console.log("Đang bận, từ chối cuộc gọi từ", call.peer);
                    call.close();
                    return;
                }
                console.log('Có cuộc gọi đến từ', call.peer);
                call.answer(localStream);
                setupCall(call);
            });
        })();

        // 5. Hàm thực hiện cuộc gọi
        function makeCall() {
            const callId = document.getElementById('callId').value;
            if (!callId) {
                alert('Vui lòng nhập ID của người bạn muốn gọi');
                return;
            }
            if (currentCall) {
                alert("Bạn đang trong một cuộc gọi. Vui lòng kết thúc cuộc gọi cũ trước.");
                return;
            }
            console.log('Đang gọi', callId);
            const call = peer.call(callId, localStream);
            setupCall(call);
        }

        // 6. Hàm xử lý logic cho cả cuộc gọi đi và đến
        function setupCall(call) {
            document.getElementById('callBtn').disabled = true;
            document.getElementById('hangUpBtn').disabled = false;
            document.getElementById('callStatus').textContent = `Đang kết nối với ${call.peer}...`;

            call.on('stream', remoteStream => {
                console.log('Nhận được stream từ', call.peer);
                const remoteVideoEl = document.getElementById('remoteVideo');
                
                if (remoteVideoEl.srcObject) {
                    console.log("Đã có stream, bỏ qua event 'stream' trùng lặp.");
                    return; 
                }
                
                remoteVideoEl.srcObject = remoteStream;
                
                // Vẫn cố gắng .play() ở đây
                remoteVideoEl.play().catch(e => {
                    // Không alert nữa, chỉ ghi log. Chúng ta sẽ chờ người dùng click.
                    console.warn("Lỗi tự động phát video (sẽ thử lại khi click):", e.name);
                });

                document.getElementById('callStatus').textContent = `Đã kết nối với ${call.peer}`;
            });

            call.on('close', () => {
                console.log('Cuộc gọi kết thúc');
                endCall();
            });

            call.on('error', err => {
                console.error('Lỗi cuộc gọi:', err);
                alert('Không thể thực hiện cuộc gọi. Người kia có thể đã offline hoặc ID không đúng.');
                endCall();
            });

            currentCall = call;
        }

        // 7. Hàm kết thúc cuộc gọi (chủ động)
        function hangUp() {
            if (currentCall) {
                console.log("Kết thúc cuộc gọi...");
                currentCall.close();
                endCall();
            }
        }
        
        // 8. Hàm dọn dẹp sau khi kết thúc cuộc gọi
        function endCall() {
            const remoteVideoEl = document.getElementById('remoteVideo');
            remoteVideoEl.srcObject = null;
            remoteVideoEl.muted = true; // Luôn tắt tiếng khi kết thúc
            
            document.getElementById('callStatus').textContent = 'Sẵn sàng';
            document.getElementById('callBtn').disabled = false;
            document.getElementById('hangUpBtn').disabled = true;
            currentCall = null;
        }

        // ======================================================
        // ***** THAY ĐỔI 2: Hàm click sẽ vừa .play() vừa bật/tắt tiếng *****
        // ======================================================
        document.getElementById('remoteVideo').addEventListener('click', () => {
            const remoteVideoEl = document.getElementById('remoteVideo');
            if (remoteVideoEl.srcObject) { // Chỉ thay đổi nếu đang có video
                
                // 1. Ép video phải phát (giải quyết lỗi autoplay thất bại)
                remoteVideoEl.play().catch(e => {
                    console.error("Lỗi khi .play() lúc click:", e);
                    alert("Không thể phát video. Lỗi: " + e.name);
                });

                // 2. Bật/tắt tiếng
                remoteVideoEl.muted = !remoteVideoEl.muted;
                if (remoteVideoEl.muted) {
                    console.log("Đã TẮT tiếng video đối phương.");
                } else {
                    console.log("Đã BẬT tiếng video đối phương.");
                }
            }
        });


        // Dọn dẹp khi tắt tab
        window.addEventListener('beforeunload', () => {
            hangUp();
            if (peer) {
                peer.destroy();
            }
        });

    </script>
</body>
</html>