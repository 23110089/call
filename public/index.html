<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Call</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>WebRTC Video Call (Render + Coturn + Rooms)</h1>
    <div class="video-container">
        <video id="localVideo" autoplay playsinline muted></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>
    <div class="controls">
        <input type="text" id="roomIdInput" placeholder="Nhập ID phòng...">
        <br>
        <button id="joinButton">1. Tham gia phòng</button> <button id="hangupButton" disabled>2. Kết thúc</button>
        <button id="toggleCamButton" disabled>Tắt Camera</button>
        <button id="toggleMicButton" disabled>Tắt Micro</button>
    </div>

    <script>
        // === PHẦN 1: CẤU HÌNH (Giữ nguyên) ===
        const SIGNALING_SERVER_URL = 'wss://callvideo0506.onrender.com';
        const iceConfig = {
            'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                {
                    urls: 'turn:51.255.83.152:21500?transport=udp',
                    username: 'nstd',
                    credential: '2503'
                },
                {
                    urls: 'turn:51.255.83.152:21500?transport=tcp',
                    username: 'nstd',
                    credential: '2503'
                }
            ]
        };

        // === PHẦN 2: LOGIC ỨNG DỤNG (Cập nhật) ===

        // Nút 'startButton' đã bị xóa
        const joinButton = document.getElementById('joinButton');
        const hangupButton = document.getElementById('hangupButton');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const roomIdInput = document.getElementById('roomIdInput');

        // Thêm nút điều khiển Cam/Mic
        const toggleCamButton = document.getElementById('toggleCamButton');
        const toggleMicButton = document.getElementById('toggleMicButton');

        let localStream;
        let remoteStream;
        let pc; // RTCPeerConnection
        let ws; // WebSocket

        // Xóa startButton.onclick
        joinButton.onclick = joinRoom;
        hangupButton.onclick = hangup;
        // Thêm sự kiện click cho nút mới
        toggleCamButton.onclick = toggleCamera;
        toggleMicButton.onclick = toggleMicrophone;

        // Xóa hàm 'start()' cũ

        function connectToSignaling() {
            // ... (Nội dung hàm này giữ nguyên) ...
            console.log('Connecting to signaling server...');
            ws = new WebSocket(SIGNALING_SERVER_URL);

            ws.onopen = () => {
                console.log('Connected to signaling server');
                // Gửi tin nhắn 'join' NGAY SAU KHI KẾT NỐI
                const roomId = roomIdInput.value;
                console.log(`Joining room: ${roomId}`);
                ws.send(JSON.stringify({ type: 'join', roomId: roomId }));

                // Tạo PeerConnection sẵn sàng
                if (!pc) createPeerConnection();
            };

            ws.onmessage = async (e) => {
                const message = JSON.parse(e.data);
                console.log('Received message:', message);

                if (message.offer) {
                    if (!pc) createPeerConnection();
                    await pc.setRemoteDescription(new RTCSessionDescription(message.offer));
                    console.log('Creating answer');
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    ws.send(JSON.stringify({ answer: answer }));
                
                } else if (message.answer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(message.answer));
                
                } else if (message.candidate) {
                    try {
                        await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
                    } catch (err) {
                        console.error('Error adding received ice candidate', err);
                    }
                } else if (message.type === 'createOffer') {
                    console.log('Server requested offer');
                    await createOfferAndSend();
                } else if (message.type === 'peerLeft') {
                    console.log('Peer left');
                    hangup();
                } else if (message.error) {
                    alert('Lỗi từ máy chủ: ' + message.error);
                    hangup(); // Tự động ngắt kết nối nếu phòng đầy
                }
            };

            ws.onclose = () => {
                console.log('Disconnected from signaling server');
            };
        }

        function createPeerConnection() {
            // ... (Nội dung hàm này giữ nguyên) ...
            console.log('Creating PeerConnection');
            pc = new RTCPeerConnection(iceConfig);

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Sending ICE candidate');
                    ws.send(JSON.stringify({ candidate: event.candidate }));
                }
            };

            pc.ontrack = (event) => {
                console.log('Received remote track');
                if (!remoteStream) {
                    remoteStream = new MediaStream();
                    remoteVideo.srcObject = remoteStream;
                }
                remoteStream.addTrack(event.track);
            };

            // Thêm các track từ localStream vào PeerConnection
            if (localStream) {
                 localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }
        }

        // HÀM joinRoom() ĐƯỢC CẬP NHẬT (thay thế hàm start())
        async function joinRoom() {
            const roomId = roomIdInput.value;
            if (!roomId) {
                alert('Vui lòng nhập ID phòng');
                return;
            }

            // 1. Vô hiệu hóa các nút điều khiển
            joinButton.disabled = true;
            roomIdInput.disabled = true; // Không cho đổi phòng khi đang tham gia

            try {
                // 2. Lấy stream (logic từ hàm start() cũ)
                console.log('Requesting local stream');
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                console.log('Received local stream');

                // 3. Kết nối đến máy chủ báo hiệu
                connectToSignaling(); // Hàm này sẽ tự động 'join' khi kết nối thành công

                // 4. Kích hoạt các nút điều khiển cuộc gọi
                hangupButton.disabled = false;
                toggleCamButton.disabled = false;
                toggleMicButton.disabled = false;

            } catch (e) {
                alert(`Không thể lấy camera/micro: ${e.name}`);
                // Nếu thất bại, kích hoạt lại nút join
                joinButton.disabled = false;
                roomIdInput.disabled = false;
            }
        }

        // HÀM 'CALL' CŨ (Giữ nguyên)
        async function createOfferAndSend() {
            // ... (Nội dung hàm này giữ nguyên) ...
            console.log('Creating offer as requested');
            if (!pc) {
                console.error('PeerConnection not ready!');
                return;
            }
            console.log('Creating offer');
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            console.log('Sending offer');
            ws.send(JSON.stringify({ offer: offer }));
        }

        // HÀM hangup() ĐƯỢC CẬP NHẬT
        function hangup() {
            console.log('Hanging up');
            if (pc) {
                pc.close();
                pc = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            remoteVideo.srcObject = null;
            localVideo.srcObject = null;

            // Kích hoạt lại nút join (thay vì start)
            joinButton.disabled = false;
            roomIdInput.disabled = false;
            hangupButton.disabled = true;

            // Vô hiệu hóa và reset nút cam/mic
            toggleCamButton.disabled = true;
            toggleMicButton.disabled = true;
            toggleCamButton.textContent = 'Tắt Camera';
            toggleMicButton.textContent = 'Tắt Micro';
            toggleCamButton.classList.remove('toggled-off');
            toggleMicButton.classList.remove('toggled-off');
            
            if(ws) ws.close();
        }

        // === HÀM MỚI: Bật/Tắt Camera ===
        function toggleCamera() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                if (videoTrack.enabled) {
                    toggleCamButton.textContent = 'Tắt Camera';
                    toggleCamButton.classList.remove('toggled-off');
                } else {
                    toggleCamButton.textContent = 'Bật Camera';
                    toggleCamButton.classList.add('toggled-off');
                }
            }
        }

        // === HÀM MỚI: Bật/Tắt Micro ===
        function toggleMicrophone() {
            if (!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                if (audioTrack.enabled) {
                    toggleMicButton.textContent = 'Tắt Micro';
                    toggleMicButton.classList.remove('toggled-off');
                } else {
                    toggleMicButton.textContent = 'Bật Micro';
                    toggleMicButton.classList.add('toggled-off');
                }
            }
        }

    </script>
</body>
</html>