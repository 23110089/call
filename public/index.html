<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Call</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="video-container">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
    </div>

    <div class="controls">
        <input type="text" id="roomIdInput" placeholder="Nhập ID phòng...">
        <br>
        <button id="joinButton">Tham gia phòng</button>
        <button id="hangupButton" disabled>Kết thúc</button>
        <button id="toggleCamButton" disabled>Tắt Camera</button>
        <button id="toggleMicButton" disabled>Tắt Micro</button>
        <button id="switchCameraButton" disabled>Đảo Camera</button> </div>

    <script>
        // === PHẦN 1: CẤU HÌNH (Giữ nguyên) ===
        const SIGNALING_SERVER_URL = 'wss://callvideo0506.onrender.com';
        const iceConfig = {
            'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                {
                    urls: 'turn:51.255.83.152:21500?transport=udp',
                    username: 'nstd',
                    credential: '2503'
                },
                {
                    urls: 'turn:51.255.83.152:21500?transport=tcp',
                    username: 'nstd',
                    credential: '2503'
                }
            ]
        };

        // === PHẦN 2: LOGIC ỨNG DỤNG (Cập nhật) ===

        const joinButton = document.getElementById('joinButton');
        const hangupButton = document.getElementById('hangupButton');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const roomIdInput = document.getElementById('roomIdInput');

        const toggleCamButton = document.getElementById('toggleCamButton');
        const toggleMicButton = document.getElementById('toggleMicButton');
        const switchCameraButton = document.getElementById('switchCameraButton'); // Nút đảo camera
        const controlsDiv = document.querySelector('.controls'); // Lấy thanh điều khiển

        let localStream;
        let remoteStream;
        let pc; // RTCPeerConnection
        let ws; // WebSocket
        let currentCameraId; // Lưu ID của camera đang dùng
        let hideControlsTimeout; // Biến lưu timeout để ẩn thanh điều khiển

        // === LOGIC TỰ ĐỘNG ẨN/HIỆN THANH ĐIỀU KHIỂN ===
        function showControls() {
            controlsDiv.classList.remove('hidden');
            resetHideControlsTimer();
        }

        function hideControls() {
            controlsDiv.classList.add('hidden');
        }

        function resetHideControlsTimer() {
            // Xóa timeout cũ nếu có
            if (hideControlsTimeout) {
                clearTimeout(hideControlsTimeout);
            }
            // Đặt timeout mới để ẩn sau 3 giây
            hideControlsTimeout = setTimeout(() => {
                hideControls();
            }, 3000);
        }

        // Hiện thanh điều khiển khi di chuyển chuột hoặc chạm màn hình
        document.addEventListener('mousemove', showControls);
        document.addEventListener('touchstart', showControls);
        document.addEventListener('click', showControls);

        // Khởi động timer khi trang load
        resetHideControlsTimer();

        joinButton.onclick = joinRoom;
        hangupButton.onclick = hangup;
        toggleCamButton.onclick = toggleCamera;
        toggleMicButton.onclick = toggleMicrophone;
        switchCameraButton.onclick = switchCamera; // Gán sự kiện cho nút đảo camera

        function connectToSignaling() {
            console.log('Connecting to signaling server...');
            ws = new WebSocket(SIGNALING_SERVER_URL);

            ws.onopen = () => {
                console.log('Connected to signaling server');
                const roomId = roomIdInput.value;
                console.log(`Joining room: ${roomId}`);
                ws.send(JSON.stringify({ type: 'join', roomId: roomId }));

                if (!pc) createPeerConnection();
            };

            ws.onmessage = async (e) => {
                const message = JSON.parse(e.data);
                console.log('Received message:', message);

                if (message.offer) {
                    if (!pc) createPeerConnection();
                    await pc.setRemoteDescription(new RTCSessionDescription(message.offer));
                    console.log('Creating answer');
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    ws.send(JSON.stringify({ answer: answer }));
                
                } else if (message.answer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(message.answer));
                
                } else if (message.candidate) {
                    try {
                        await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
                    } catch (err) {
                        console.error('Error adding received ice candidate', err);
                    }
                } else if (message.type === 'createOffer') {
                    console.log('Server requested offer');
                    await createOfferAndSend();
                } else if (message.type === 'peerLeft') {
                    console.log('Peer left');
                    hangup();
                } else if (message.error) {
                    alert('Lỗi từ máy chủ: ' + message.error);
                    hangup();
                }
            };

            ws.onclose = () => {
                console.log('Disconnected from signaling server');
            };
        }

        function createPeerConnection() {
            console.log('Creating PeerConnection');
            pc = new RTCPeerConnection(iceConfig);

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Sending ICE candidate');
                    ws.send(JSON.stringify({ candidate: event.candidate }));
                }
            };

            pc.ontrack = (event) => {
                console.log('Received remote track');
                if (!remoteStream) {
                    remoteStream = new MediaStream();
                    remoteVideo.srcObject = remoteStream;
                }
                remoteStream.addTrack(event.track);
            };

            if (localStream) {
                 localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }
        }

        async function joinRoom() {
            const roomId = roomIdInput.value;
            if (!roomId) {
                alert('Vui lòng nhập ID phòng');
                return;
            }

            joinButton.disabled = true;
            roomIdInput.disabled = true;

            try {
                console.log('Requesting local stream');
                // Lấy stream ban đầu, không chỉ định camera ID
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                console.log('Received local stream');

                // Lấy camera ID của camera mặc định ban đầu
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    currentCameraId = videoTrack.getSettings().deviceId;
                    // Kiểm tra xem có hơn 1 camera không để kích hoạt nút đảo
                    const videoDevices = await navigator.mediaDevices.enumerateDevices();
                    const cameras = videoDevices.filter(device => device.kind === 'videoinput');
                    if (cameras.length > 1) {
                        switchCameraButton.disabled = false;
                    }
                }

                connectToSignaling();

                hangupButton.disabled = false;
                toggleCamButton.disabled = false;
                toggleMicButton.disabled = false;

            } catch (e) {
                alert(`Không thể lấy camera/micro: ${e.name}`);
                joinButton.disabled = false;
                roomIdInput.disabled = false;
            }
        }

        async function createOfferAndSend() {
            console.log('Creating offer as requested');
            if (!pc) {
                console.error('PeerConnection not ready!');
                return;
            }
            console.log('Creating offer');
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            console.log('Sending offer');
            ws.send(JSON.stringify({ offer: offer }));
        }

        function hangup() {
            console.log('Hanging up');
            if (pc) {
                pc.close();
                pc = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            remoteVideo.srcObject = null;
            localVideo.srcObject = null;

            joinButton.disabled = false;
            roomIdInput.disabled = false;
            hangupButton.disabled = true;

            toggleCamButton.disabled = true;
            toggleMicButton.disabled = true;
            switchCameraButton.disabled = true; // Vô hiệu hóa nút đảo camera
            
            toggleCamButton.textContent = 'Tắt Camera';
            toggleMicButton.textContent = 'Tắt Micro';
            toggleCamButton.classList.remove('toggled-off');
            toggleMicButton.classList.remove('toggled-off');
            localVideo.classList.remove('hidden'); // Đảm bảo video hiện lại
            
            if(ws) ws.close();
        }

        function toggleCamera() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                if (videoTrack.enabled) {
                    toggleCamButton.textContent = 'Tắt Camera';
                    toggleCamButton.classList.remove('toggled-off');
                    localVideo.classList.remove('hidden'); // Hiện video
                } else {
                    toggleCamButton.textContent = 'Bật Camera';
                    toggleCamButton.classList.add('toggled-off');
                    localVideo.classList.add('hidden'); // Ẩn video
                }
            }
        }

        function toggleMicrophone() {
            if (!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                if (audioTrack.enabled) {
                    toggleMicButton.textContent = 'Tắt Micro';
                    toggleMicButton.classList.remove('toggled-off');
                } else {
                    toggleMicButton.textContent = 'Bật Micro';
                    toggleMicButton.classList.add('toggled-off');
                }
            }
        }

        // === HÀM MỚI: Đảo Camera ===
        async function switchCamera() {
            if (!localStream) return;

            try {
                // 1. Dừng tất cả các track hiện có trong localStream
                localStream.getTracks().forEach(track => track.stop());
                
                // 2. Lấy danh sách camera
                const videoDevices = await navigator.mediaDevices.enumerateDevices();
                const cameras = videoDevices.filter(device => device.kind === 'videoinput');

                if (cameras.length <= 1) {
                    alert('Chỉ có một camera được tìm thấy.');
                    return;
                }

                // 3. Tìm camera kế tiếp
                const currentCameraIndex = cameras.findIndex(cam => cam.deviceId === currentCameraId);
                const nextCameraIndex = (currentCameraIndex + 1) % cameras.length;
                const nextCamera = cameras[nextCameraIndex];

                // 4. Lấy stream từ camera mới
                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: nextCamera.deviceId } },
                    audio: true
                });

                // 5. Cập nhật localStream và video UI
                localVideo.srcObject = newStream;
                localStream = newStream;
                currentCameraId = nextCamera.deviceId;

                // 6. Thay thế track video trong PeerConnection
                // Đây là phần quan trọng để PeerConnection gửi stream mới đi
                if (pc) {
                    const oldVideoTrack = pc.getSenders().find(sender => sender.track && sender.track.kind === 'video');
                    if (oldVideoTrack) {
                        await oldVideoTrack.replaceTrack(newStream.getVideoTracks()[0]);
                        console.log('Video track replaced in PeerConnection.');
                    } else {
                        // Nếu chưa có video track, thêm vào
                        newStream.getVideoTracks().forEach(track => pc.addTrack(track, newStream));
                        console.log('New video track added to PeerConnection.');
                    }
                }

                // Cập nhật trạng thái nút Tắt Camera
                toggleCamButton.textContent = 'Tắt Camera';
                toggleCamButton.classList.remove('toggled-off');
                // Đảm bảo audio cũng được kích hoạt nếu có
                if (newStream.getAudioTracks().length > 0) {
                    toggleMicButton.textContent = 'Tắt Micro';
                    toggleMicButton.classList.remove('toggled-off');
                }

            } catch (e) {
                console.error('Lỗi khi đảo camera:', e);
                alert(`Lỗi khi đảo camera: ${e.message}`);
            }
        }

    </script>
</body>
</html>