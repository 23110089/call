<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test ICE Connectivity</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #fff; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 10px 0; }
    #results { background: #2d2d2d; padding: 15px; border-radius: 5px; margin-top: 20px; }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .info { color: #dcdcaa; }
    .warning { color: #ce9178; }
  </style>
</head>
<body>
  <h2>üß™ Test ICE Connectivity</h2>
  <p>Ki·ªÉm tra xem STUN/TURN servers c√≥ ho·∫°t ƒë·ªông kh√¥ng</p>
  <button onclick="testICE()">Run Test</button>
  <button onclick="clearResults()">Clear</button>
  <div id="results"></div>

  <script>
    const resultsDiv = document.getElementById('results');
    
    function log(message, type = 'info') {
      const p = document.createElement('p');
      p.className = type;
      p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      resultsDiv.appendChild(p);
      resultsDiv.scrollTop = resultsDiv.scrollHeight;
    }
    
    function clearResults() {
      resultsDiv.innerHTML = '';
    }
    
    async function testICE() {
      clearResults();
      log('üöÄ B·∫Øt ƒë·∫ßu test ICE connectivity...', 'info');
      
      try {
        // Fetch ICE servers config
        log('üì° ƒêang l·∫•y c·∫•u h√¨nh ICE servers...', 'info');
        const resp = await fetch('/config');
        const config = await resp.json();
        log(`‚úÖ Nh·∫≠n ƒë∆∞·ª£c ${config.iceServers.length} ICE servers`, 'success');
        
        config.iceServers.forEach((server, i) => {
          log(`  ${i+1}. ${server.urls}`, 'info');
        });
        
        // Create RTCPeerConnection
        log('üîå T·∫°o RTCPeerConnection...', 'info');
        const pc = new RTCPeerConnection(config);
        
        let candidateCount = 0;
        let hasRelay = false;
        let hasHost = false;
        let hasSrflx = false;
        
        pc.onicecandidate = (event) => {
          if (event.candidate) {
            candidateCount++;
            const candidate = event.candidate.candidate;
            log(`ICE Candidate ${candidateCount}: ${candidate}`, 'info');
            
            if (candidate.includes('typ relay')) {
              hasRelay = true;
              log('  ‚úÖ RELAY candidate (TURN) - T·ªët!', 'success');
            } else if (candidate.includes('typ host')) {
              hasHost = true;
              log('  ‚ÑπÔ∏è HOST candidate (local)', 'info');
            } else if (candidate.includes('typ srflx')) {
              hasSrflx = true;
              log('  ‚úÖ SRFLX candidate (STUN) - T·ªët!', 'success');
            }
          } else {
            // ICE gathering completed
            log('üèÅ ICE gathering ho√†n t·∫•t', 'success');
            log(`üìä T·ªïng k·∫øt:`, 'info');
            log(`  - Host candidates: ${hasHost ? '‚úÖ' : '‚ùå'}`, hasHost ? 'success' : 'error');
            log(`  - SRFLX candidates (STUN): ${hasSrflx ? '‚úÖ' : '‚ùå'}`, hasSrflx ? 'success' : 'error');
            log(`  - RELAY candidates (TURN): ${hasRelay ? '‚úÖ' : '‚ùå'}`, hasRelay ? 'success' : 'warning');
            
            if (hasRelay) {
              log('üéâ TURN server ho·∫°t ƒë·ªông! C√≥ th·ªÉ k·∫øt n·ªëi qua m·∫°ng kh√°c nhau.', 'success');
            } else if (hasSrflx) {
              log('‚ö†Ô∏è Ch·ªâ c√≥ STUN. C√≥ th·ªÉ k·∫øt n·ªëi n·∫øu NAT kh√¥ng qu√° nghi√™m ng·∫∑t.', 'warning');
            } else {
              log('‚ùå Kh√¥ng c√≥ STUN/TURN candidates. Ch·ªâ k·∫øt n·ªëi ƒë∆∞·ª£c c√πng m·∫°ng LAN.', 'error');
            }
          }
        };
        
        pc.onicegatheringstatechange = () => {
          log(`ICE gathering state: ${pc.iceGatheringState}`, 'info');
        };
        
        // Create offer to trigger ICE gathering
        log('üìù T·∫°o offer ƒë·ªÉ trigger ICE gathering...', 'info');
        const offer = await pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true });
        await pc.setLocalDescription(offer);
        log('‚úÖ Offer created, ƒëang thu th·∫≠p ICE candidates...', 'success');
        
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        console.error(error);
      }
    }
  </script>
</body>
</html>
